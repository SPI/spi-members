# Copyright (C) 2001  Craig Small <csmall@debian.org>
# Copyright (C) 2001, 2002, 2003, 2004, 2005  Martin Michlmayr <tbm@cyrius.com>
# Copyright (C) 2003, 2004  Peter Palfrader <weasel@debian.org>
# This file may be distributed under the GPL v2 or higher.

<?
  session_start();
  include("config.inc");
  include("common.inc");

  function delete_member($db, $email) {
    if (! ($query = pg_query_params($db,
            'SELECT memid FROM members WHERE email = $1', array($email)))) {
      echo "<P>Problem with query", pg_errorMessage($db), "<BR>";
      return FALSE;
    }
    if (pg_NumRows($query) == 0) {
      echo "<P>No member found with email '$email'<BR>\n";
      return FALSE;
    }
    $row = pg_Fetch_Array($query, 0);
    $memid = $row["memid"];

    if (! ($query = pg_query_params($db,
            'DELETE FROM applications WHERE member = $1', array($memid)))) {
      echo "<P>Problem with query", pg_errorMessage($db), "<BR>";
      echo "SQL was: $sql<BR>\n";
      return FALSE;
    }
    if (! ($query = pg_query_params($db,
            'DELETE FROM members WHERE memid = $1', array($memid)))) {
      echo "<P>Problem with query", pg_errorMessage($db), "<BR>";
      echo "SQL was: $sql<BR>\n";
      return FALSE;
    }

    return TRUE;
  }
?>
#use wml::nmpage title="SPI Membership - Delete Member"
<?
  if (!isset($_SESSION["s_username"]) || !isset($_SESSION['s_ismanager'])) {
?>
<P>You do not have permission to view this page.  The problem is session management failed or timed out.  You must be an application manager to access this 
screen.
<?
  } else { #sess reg

  $db = open_db();
    if ($sure != 'yes') {
      echo "<P>You did not click the confirm button, abandoning delete.";
    } else if ($email == '') {
      echo "<P>No email address specified.";
    } else if (! delete_member($db, $email)) {
      echo "<P>Something went wrong trying to delete user.";
    } else {
      echo "<P>User <b>$email</b> successfully deleted.";
    }
  }
?>
